## Debouncing and Debugging

### Debouncing

```
      ┏┓
      ┃┃╱╲ in
      ┃╱╱╲╲ this
      ╱╱╭╮╲╲ house
      ▔▏┗┛▕▔  we
      ╱▔▔▔▔▔▔▔▔▔▔╲
obey the laws of physics
     ╱╱ ┏┳┓╭╮┏┳┓ ╲╲
     ▔▏ ┗┻┛┃┃┗┻┛ ▕▔
```

Mechanical buttons and switches demonstrate a phenomenon called *switch bounce*.
This causes voltage to fluctuate for hundreds, often thousands, of microseconds when the contacts close or open.
When this fluctuation is in the indeterminate region between the logical low and high thresholds, it can cause the logic level to "bounce" back-and-forth between high and low until settling into the final, correct logic level.
This causes the digital circuitry or software to "see" multiple triggering events.

You probably saw an example of this in the prelab.

A traditional way to debounce is to introduce a simple low-pass filter using a resistor and a capacitor.
Other common hardware-based approaches use digital feedback circuits.
Hardware design can be simplified, and manufacturing cost can be reduced, by solving a hardware problem with software.
This, of course, transfers the design complexity to the software.

The CowPi library includes the `cowpi_debounce_byte()`, `cowpi_debounce_short()`, and `cowpi_debounce_long()`  functions that essentially implement a low-pass filter in software.
The functions in *io_functions.c* make use of `cowpi_debounce_byte()` and `cowpi_debounce_long()`.
When you modify these functions, as long as you preserve those `cowpi_debounce_byte()` calls, you do not need to worry further about debouncing.


### Debugging

You can send short debug messages to the Cow&nbsp;Pi's display, as you saw in the prelab.
The display module can display up to 8 rows of text, 16 characters per row;
however, the assignment only makes use of rows&nbsp;0 \& 1.
This leaves rows&nbsp;2--7 available for short (16 character) debug messages.
You might find `count_visits`, declared in *display.h*, to be useful.


### Paying Attention to Compiler Warnings

As always, you should pay attention to compiler warnings as "pre-debugging".
The first time you build a project, you will see several compiler warnings generated for the Arduino/MBED framework, which is unfortunate.
After that, any compiler warnings that you see will only be in the project code.

Even so, because additional information is printed after the compilation step, you will want to scroll through the build messages to look for compiler warnings.
Here is an example output that shows two compiler warnings, generated by compiling the starter code:
```
Processing pico (platform: raspberrypi; board: pico; framework: arduino)
--------------------------------------------------------------------------------
Verbose mode can be enabled via `-v, --verbose` option
CONFIGURATION: https://docs.platformio.org/page/boards/raspberrypi/pico.html
PLATFORM: Raspberry Pi RP2040 (1.14.0) > Raspberry Pi Pico
HARDWARE: RP2040 133MHz, 264KB RAM, 2MB Flash
DEBUG: Current (cmsis-dap) External (cmsis-dap, jlink, raspberrypi-swd)
PACKAGES: 
 - framework-arduino-mbed @ 4.1.5 
 - tool-rp2040tools @ 1.0.2 
 - toolchain-gccarmnoneeabi @ 1.90201.191206 (9.2.1)
LDF: Library Dependency Finder -> https://bit.ly/configure-pio-ldf
LDF Modes: Finder ~ chain, Compatibility ~ soft
Found 47 compatible libraries
Scanning dependencies...
Dependency Graph
|-- CowPi @ 0.8.2
|-- OneBitDisplay @ 2.3.3
|-- CowPi_stdio @ 0.6.3
Building in release mode
Compiling .pio/build/pico/src/io_functions.c.o
src/io_functions.c:43:32: warning: 'timer' defined but not used [-Wunused-variable]
   43 | static cowpi_timer_t volatile *timer;
      |                                ^~~~~
src/io_functions.c:42:33: warning: 'ioport' defined but not used [-Wunused-variable]
   42 | static cowpi_ioport_t volatile *ioport;
      |                                 ^~~~~~
Linking .pio/build/pico/firmware.elf
Generating UF2 image
elf2uf2 ".pio/build/pico/firmware.elf" ".pio/build/pico/firmware.uf2"
Checking size .pio/build/pico/firmware.elf
Advanced Memory Usage is available via "PlatformIO Home > Project Inspect"
RAM:   [==        ]  16.9% (used 45572 bytes from 270336 bytes)
Flash: [          ]   0.3% (used 5566 bytes from 2097152 bytes)
Building .pio/build/pico/firmware.bin
after_build(["buildprog"], [".pio/build/pico/firmware.bin"])
Generated: /Users/cbohn2/courses/textbook/labs/integrated-labs/ControlPanelLab/.pio/build/pico/ControlPanelLab-20251102-1059.uf2
Also copied to: /Users/cbohn2/courses/textbook/labs/integrated-labs/ControlPanelLab/build/ControlPanelLab-20251102-1059.uf2
after_build(["buildprog"], [".pio/build/pico/firmware.bin"])
`digitalRead` in src/io_functions.c on line 68:     bool key_is_pressed = !(digitalRead(10) && digitalRead(11) && digitalRead(12) && digitalRead(13));
`cowpi_illuminate_left_led` in src/io_functions.c on line 81:         cowpi_illuminate_left_led();
`cowpi_deluminate_left_led` in src/io_functions.c on line 83:         cowpi_deluminate_left_led();
`micros` in src/io_functions.c on line 101:     return micros();
`cowpi_left_button_is_pressed` in src/io_functions.c on line 113:     bool button_is_pressed = cowpi_left_button_is_pressed();
`cowpi_right_button_is_pressed` in src/io_functions.c on line 125:     bool button_is_pressed = cowpi_right_button_is_pressed();
`cowpi_left_switch_is_in_right_position` in src/io_functions.c on line 148:     bool switch_in_position = cowpi_left_switch_is_in_right_position();
`cowpi_right_switch_is_in_right_position` in src/io_functions.c on line 171:     bool switch_in_position = cowpi_right_switch_is_in_right_position();
`cowpi_illuminate_right_led` in src/io_functions.c on line 184:         cowpi_illuminate_right_led();
`cowpi_deluminate_right_led` in src/io_functions.c on line 186:         cowpi_deluminate_right_led();
`cowpi_get_keypress` in src/io_functions.c on line 202:     char key = cowpi_get_keypress();
*** Constraint violations found ***
========================= [SUCCESS] Took 1.32 seconds =========================

```
You can see the compilation step with the compiler warning messages between the dependency graph and generating the UF2 image

---

|       [⬅️](01-getting-started.md)        |      [⬆️](../README.md)      |             [➡️](03-labtime.md)              |
|:----------------------------------------:|:----------------------------:|:--------------------------------------------:|
| [Getting Started](01-getting-started.md) | [Front Matter](../README.md) | [Initial Changes to the Code](03-labtime.md) |
